#!/bin/bash
# Docker management script for Diquis Football Academy

set -e

# Function to show usage
show_usage() {
    echo "ğŸš€ Docker Management for Diquis Football Academy"
    echo ""
    echo "Usage: $0 [command]"
    echo ""
    echo "Commands:"
    echo "  up        Start all services (default)"
    echo "  down      Stop all services"
    echo "  restart   Restart all services"
    echo "  reset     Reset Docker environment (rebuild from scratch)"
    echo "  status    Show service status"
    echo "  logs      Follow logs for all services"
    echo "  help      Show this help message"
    echo ""
    echo "Examples:"
    echo "  $0              # Start services"
    echo "  $0 up           # Start services"
    echo "  $0 down         # Stop services"
    echo "  $0 restart      # Restart services"
    echo "  $0 status       # Check status"
}

# Function to check Docker
check_docker() {
    if ! docker info >/dev/null 2>&1; then
        echo "âŒ Docker is not running. Please start Docker first."
        exit 1
    fi
}

# Function to ensure env file exists
ensure_env_file() {
    if [ ! -f .env ]; then
        echo "ğŸ“‹ Creating .env from template..."
        cp .env.example .env
        echo "âœ… Environment file created"
        echo "âš ï¸  Please review and customize .env with your passwords"
        echo ""
    fi
}

# Function to start services
start_services() {
    echo "ğŸš€ Starting Diquis Football Academy Services"
    echo ""

    check_docker
    ensure_env_file

    echo "ğŸ—ï¸  Building Docker images (if needed)..."
    docker compose build

    echo ""
    echo "ğŸ—ï¸  Starting services with docker compose..."
    docker compose up -d

    echo ""
    echo "â³ Waiting for services to initialize..."
    sleep 15

    echo ""
    echo "ğŸ” Service Status:"
    docker compose ps

    echo ""
    echo "ğŸ“¦ Installing/checking gems..."
    docker compose exec -T web bundle install
    
    echo ""
    echo "ğŸ”„ Restarting services to pick up new gems..."
    docker compose restart web sidekiq
    
    echo ""
    echo "â³ Waiting for services to restart..."
    sleep 10

    echo ""
    echo "ğŸ“¦ Setting up database..."
    
    # Check if database exists and has migrations
    if docker compose exec -T web bundle exec rails db:version >/dev/null 2>&1; then
        echo "âœ… Database already exists, running pending migrations..."
        docker compose exec -T web bundle exec rails db:migrate
    else
        echo "ğŸ†• Creating database and running migrations..."
        docker compose exec -T web bundle exec rails db:create db:migrate
        
        echo ""
        echo "ğŸŒ± Loading seed data..."
        docker compose exec -T web bundle exec rails db:seed
    fi

    echo ""
    echo "âœ… Services are running!"
    echo ""
    echo "ğŸŒ Access Points:"
    echo "  Rails App:       http://localhost:3000"
    echo "  Sidekiq Web:     http://localhost:4567"
    echo "  PostgreSQL:      localhost:5432"
    echo "  Redis:           localhost:6379"
    echo ""
    echo "ğŸ”§ Quick Commands:"
    echo "  Stop services:   ./docker-dev down"
    echo "  Reset all:       ./docker-dev reset"
    echo "  View logs:       ./docker-dev logs"
    echo "  Check status:    ./docker-dev status"
    echo "  Rails console:   docker compose exec web bundle exec rails console"
    echo ""
    echo "ğŸ’¡ Vite dev server runs inside the web container (started by Procfile)"
    echo ""
    echo "ğŸ‰ Happy coding!"
}

# Function to stop services
stop_services() {
    echo "ğŸ›‘ Stopping Diquis Football Academy Services"
    echo ""

    check_docker

    echo "ğŸ—ï¸  Stopping services with docker compose..."
    docker compose down

    echo ""
    echo "âœ… All services stopped!"
    echo ""
    echo "ğŸ’¡ To start again: ./docker-dev up"
}

# Function to restart services
restart_services() {
    echo "ğŸ”„ Restarting Diquis Football Academy Services"
    echo ""
    
    check_docker
    
    echo "ğŸ—ï¸  Restarting services..."
    docker compose restart
    
    echo ""
    echo "â³ Waiting for services to stabilize..."
    sleep 10
    
    echo ""
    echo "ğŸ” Service Status:"
    docker compose ps
    
    echo ""
    echo "âœ… Services restarted!"
}

# Function to show status
show_status() {
    echo "ğŸ” Diquis Football Academy Service Status"
    echo ""
    
    check_docker
    
    docker compose ps
    
    echo ""
    echo "ğŸ’¡ Commands:"
    echo "  Start:    ./docker-dev up"
    echo "  Stop:     ./docker-dev down"
    echo "  Restart:  ./docker-dev restart"
    echo "  Logs:     ./docker-dev logs"
}

# Function to show logs
show_logs() {
    echo "ğŸ“‹ Following logs for all services (Ctrl+C to exit)"
    echo ""
    
    check_docker
    docker compose logs -f
}

# Function to reset Docker environment
reset_environment() {
    echo "ğŸ”„ RESETTING Docker Environment"
    echo ""
    echo "âš ï¸  WARNING: This will delete all containers, volumes, and images!"
    echo "âš ï¸  All database data will be lost!"
    echo ""
    read -p "Are you sure you want to continue? (yes/no): " confirm
    
    if [ "$confirm" != "yes" ]; then
        echo "âŒ Reset cancelled"
        exit 0
    fi
    
    echo ""
    check_docker
    
    echo "ğŸ›‘ Stopping and removing all containers and volumes..."
    docker compose down -v
    
    echo ""
    echo "ğŸ§¹ Removing dangling images..."
    docker compose rm -f
    
    echo ""
    echo "ğŸ—‘ï¸  Pruning Docker system..."
    docker system prune -f
    
    echo ""
    echo "âœ… Docker environment has been reset!"
    echo ""
    echo "ğŸ’¡ Next steps:"
    echo "  1. Start services:  ./docker-dev up"
    echo ""
    echo "ğŸ‰ Ready for a fresh start!"
}

# Parse command line arguments
case "${1:-up}" in
    up|start)
        start_services
        ;;
    down|stop)
        stop_services
        ;;
    restart)
        restart_services
        ;;
    reset)
        reset_environment
        ;;
    status|ps)
        show_status
        ;;
    logs)
        show_logs
        ;;
    help|--help|-h)
        show_usage
        ;;
    *)
        echo "âŒ Unknown command: $1"
        echo ""
        show_usage
        exit 1
        ;;
esac